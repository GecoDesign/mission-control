<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Time & Budget Tracker - Geco Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 5px;
        }

        nav {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: var(--surface);
            border-color: var(--primary);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 13px;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
        }

        .close-btn:hover {
            color: var(--text);
        }

        .project-item {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .project-client {
            font-size: 14px;
            color: var(--text-muted);
        }

        .project-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .progress-bar-container {
            background: var(--bg);
            border-radius: 4px;
            height: 24px;
            margin-bottom: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .progress-bar.warning {
            background: var(--warning);
        }

        .progress-bar.danger {
            background: var(--danger);
        }

        .progress-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .time-entry {
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
        }

        .time-entry:last-child {
            border-bottom: none;
        }

        .time-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .time-entry-date {
            font-size: 13px;
            color: var(--text-muted);
        }

        .time-entry-hours {
            font-weight: 600;
            color: var(--primary);
        }

        .time-entry-description {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .time-entry-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-muted);
        }

        td {
            font-size: 14px;
        }

        tr:hover {
            background: var(--bg);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .project-meta {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Project Time & Budget Tracker</h1>
            <div class="subtitle">Geco Design ‚Ä¢ Track profitability & optimize pricing</div>
            <nav>
                <button class="nav-btn active" onclick="showView('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showView('analytics')">Analytics</button>
                <button class="nav-btn" onclick="showView('clients')">Clients</button>
                <button class="nav-btn" onclick="showView('templates')">Templates</button>
                <button class="nav-btn" onclick="showView('export')">Export</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <div class="card-header">
                <div class="card-title">Active Projects</div>
                <button class="btn" onclick="openNewProjectModal()">+ New Project</button>
            </div>
            <div id="projectList"></div>
        </div>

        <!-- Analytics View -->
        <div id="analytics" class="view">
            <div class="card">
                <div class="card-title">Time Analytics</div>
                <div class="stats-grid" id="analyticsStats"></div>
                <div id="activityBreakdown"></div>
            </div>
            <div class="card">
                <div class="card-title">Client Profitability</div>
                <div id="clientProfitability"></div>
            </div>
        </div>

        <!-- Clients View -->
        <div id="clients" class="view">
            <div class="card">
                <div class="card-title">Clients Overview</div>
                <div id="clientsList"></div>
            </div>
        </div>

        <!-- Templates View -->
        <div id="templates" class="view">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Project Templates</div>
                    <button class="btn" onclick="openNewTemplateModal()">+ New Template</button>
                </div>
                <div id="templatesList"></div>
            </div>
        </div>

        <!-- Export View -->
        <div id="export" class="view">
            <div class="card">
                <div class="card-title">Export Data</div>
                <p style="margin-bottom: 20px; color: var(--text-muted);">Export your project and time tracking data for accounting software.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportProjects()">Export Projects (CSV)</button>
                    <button class="btn" onclick="exportTimeEntries()">Export Time Entries (CSV)</button>
                    <button class="btn btn-secondary" onclick="exportInvoiceData()">Export Invoice Data</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Data Management</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="backupData()">Backup All Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">New Project</div>
                <button class="close-btn" onclick="closeModal('newProjectModal')">&times;</button>
            </div>
            <form onsubmit="saveProject(event)">
                <div class="form-group">
                    <label>Project Name *</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label>Client *</label>
                    <input type="text" id="projectClient" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStartDate">
                    </div>
                    <div class="form-group">
                        <label>Deadline</label>
                        <input type="date" id="projectDeadline">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Budget Type *</label>
                        <select id="projectBudgetType" onchange="toggleBudgetFields()" required>
                            <option value="hourly">Hourly</option>
                            <option value="fixed">Fixed Price</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (¬£)</label>
                        <input type="number" id="projectHourlyRate" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estimated Hours</label>
                        <input type="number" id="projectEstimatedHours" step="0.5" min="0">
                    </div>
                    <div class="form-group" id="fixedBudgetField">
                        <label>Fixed Budget (¬£)</label>
                        <input type="number" id="projectFixedBudget" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Use Template</label>
                    <select id="projectTemplate" onchange="applyTemplate()">
                        <option value="">-- None --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">Create Project</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newProjectModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Detail Modal -->
    <div id="projectDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title" id="projectDetailTitle"></div>
                <button class="close-btn" onclick="closeModal('projectDetailModal')">&times;</button>
            </div>
            <div id="projectDetailContent"></div>
        </div>
    </div>

    <!-- Time Entry Modal -->
    <div id="timeEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Log Time</div>
                <button class="close-btn" onclick="closeModal('timeEntryModal')">&times;</button>
            </div>
            <form onsubmit="saveTimeEntry(event)">
                <input type="hidden" id="timeEntryProjectId">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="timeEntryDate" required>
                </div>
                <div class="form-group">
                    <label>Task Description *</label>
                    <textarea id="timeEntryDescription" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hours *</label>
                        <input type="number" id="timeEntryHours" step="0.25" min="0.25" required>
                    </div>
                    <div class="form-group">
                        <label>Activity *</label>
                        <select id="timeEntryActivity" required>
                            <option value="design">Design</option>
                            <option value="development">Development</option>
                            <option value="meetings">Meetings</option>
                            <option value="revisions">Revisions</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="timeEntryBillable" checked>
                        <label for="timeEntryBillable" style="margin: 0;">Billable</label>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">Log Time</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('timeEntryModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">New Template</div>
                <button class="close-btn" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <form onsubmit="saveTemplate(event)">
                <div class="form-group">
                    <label>Template Name *</label>
                    <input type="text" id="templateName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estimated Hours *</label>
                        <input type="number" id="templateHours" step="0.5" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Default Rate (¬£)</label>
                        <input type="number" id="templateRate" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="templateDescription"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">Save Template</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data structure
        let data = {
            projects: [],
            timeEntries: [],
            templates: []
        };

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('projectTrackerData');
            if (saved) {
                data = JSON.parse(saved);
            }
            updateTemplateDropdown();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('projectTrackerData', JSON.stringify(data));
        }

        // Initialize
        loadData();
        renderDashboard();

        // View management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');

            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'analytics') renderAnalytics();
            if (viewName === 'clients') renderClients();
            if (viewName === 'templates') renderTemplates();
        }

        // Modal management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openNewProjectModal() {
            document.getElementById('projectName').value = '';
            document.getElementById('projectClient').value = '';
            document.getElementById('projectStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectDeadline').value = '';
            document.getElementById('projectBudgetType').value = 'hourly';
            document.getElementById('projectHourlyRate').value = '';
            document.getElementById('projectEstimatedHours').value = '';
            document.getElementById('projectFixedBudget').value = '';
            document.getElementById('projectTemplate').value = '';
            toggleBudgetFields();
            openModal('newProjectModal');
        }

        function toggleBudgetFields() {
            const type = document.getElementById('projectBudgetType').value;
            const fixedField = document.getElementById('fixedBudgetField');
            if (type === 'fixed') {
                fixedField.style.display = 'block';
            } else {
                fixedField.style.display = 'none';
            }
        }

        function updateTemplateDropdown() {
            const select = document.getElementById('projectTemplate');
            select.innerHTML = '<option value="">-- None --</option>';
            data.templates.forEach(t => {
                select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
            });
        }

        function applyTemplate() {
            const templateId = document.getElementById('projectTemplate').value;
            if (!templateId) return;
            
            const template = data.templates.find(t => t.id === templateId);
            if (template) {
                document.getElementById('projectEstimatedHours').value = template.estimatedHours;
                if (template.hourlyRate) {
                    document.getElementById('projectHourlyRate').value = template.hourlyRate;
                }
            }
        }

        // Project management
        function saveProject(event) {
            event.preventDefault();
            
            const project = {
                id: Date.now().toString(),
                name: document.getElementById('projectName').value,
                client: document.getElementById('projectClient').value,
                startDate: document.getElementById('projectStartDate').value,
                deadline: document.getElementById('projectDeadline').value,
                budgetType: document.getElementById('projectBudgetType').value,
                hourlyRate: parseFloat(document.getElementById('projectHourlyRate').value) || 0,
                estimatedHours: parseFloat(document.getElementById('projectEstimatedHours').value) || 0,
                fixedBudget: parseFloat(document.getElementById('projectFixedBudget').value) || 0,
                createdAt: new Date().toISOString(),
                status: 'active'
            };

            data.projects.push(project);
            saveData();
            closeModal('newProjectModal');
            renderDashboard();
        }

        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? All associated time entries will also be deleted.')) {
                return;
            }
            data.projects = data.projects.filter(p => p.id !== projectId);
            data.timeEntries = data.timeEntries.filter(e => e.projectId !== projectId);
            saveData();
            closeModal('projectDetailModal');
            renderDashboard();
        }

        // Time entry management
        function openTimeEntryModal(projectId) {
            document.getElementById('timeEntryProjectId').value = projectId;
            document.getElementById('timeEntryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('timeEntryDescription').value = '';
            document.getElementById('timeEntryHours').value = '';
            document.getElementById('timeEntryActivity').value = 'design';
            document.getElementById('timeEntryBillable').checked = true;
            openModal('timeEntryModal');
        }

        function saveTimeEntry(event) {
            event.preventDefault();
            
            const entry = {
                id: Date.now().toString(),
                projectId: document.getElementById('timeEntryProjectId').value,
                date: document.getElementById('timeEntryDate').value,
                description: document.getElementById('timeEntryDescription').value,
                hours: parseFloat(document.getElementById('timeEntryHours').value),
                activity: document.getElementById('timeEntryActivity').value,
                billable: document.getElementById('timeEntryBillable').checked,
                createdAt: new Date().toISOString()
            };

            data.timeEntries.push(entry);
            saveData();
            closeModal('timeEntryModal');
            
            // Refresh project detail view if open
            const projectId = entry.projectId;
            openProjectDetail(projectId);
        }

        function deleteTimeEntry(entryId, projectId) {
            if (!confirm('Delete this time entry?')) return;
            data.timeEntries = data.timeEntries.filter(e => e.id !== entryId);
            saveData();
            openProjectDetail(projectId);
        }

        // Template management
        function openNewTemplateModal() {
            document.getElementById('templateName').value = '';
            document.getElementById('templateHours').value = '';
            document.getElementById('templateRate').value = '';
            document.getElementById('templateDescription').value = '';
            openModal('templateModal');
        }

        function saveTemplate(event) {
            event.preventDefault();
            
            const template = {
                id: Date.now().toString(),
                name: document.getElementById('templateName').value,
                estimatedHours: parseFloat(document.getElementById('templateHours').value),
                hourlyRate: parseFloat(document.getElementById('templateRate').value) || 0,
                description: document.getElementById('templateDescription').value,
                createdAt: new Date().toISOString()
            };

            data.templates.push(template);
            saveData();
            updateTemplateDropdown();
            closeModal('templateModal');
            renderTemplates();
        }

        function deleteTemplate(templateId) {
            if (!confirm('Delete this template?')) return;
            data.templates = data.templates.filter(t => t.id !== templateId);
            saveData();
            updateTemplateDropdown();
            renderTemplates();
        }

        // Project calculations
        function getProjectStats(project) {
            const entries = data.timeEntries.filter(e => e.projectId === project.id);
            const totalHours = entries.reduce((sum, e) => sum + e.hours, 0);
            const billableHours = entries.filter(e => e.billable).reduce((sum, e) => sum + e.hours, 0);
            const nonBillableHours = totalHours - billableHours;
            
            const revenue = project.budgetType === 'fixed' 
                ? project.fixedBudget 
                : billableHours * project.hourlyRate;
            
            const estimatedRevenue = project.budgetType === 'fixed'
                ? project.fixedBudget
                : project.estimatedHours * project.hourlyRate;
            
            const actualHourlyRate = billableHours > 0 ? revenue / billableHours : 0;
            const effectiveHourlyRate = totalHours > 0 ? revenue / totalHours : 0;
            
            const hoursProgress = project.estimatedHours > 0 
                ? (totalHours / project.estimatedHours) * 100 
                : 0;
            
            const budgetProgress = estimatedRevenue > 0
                ? (revenue / estimatedRevenue) * 100
                : 0;
            
            const profitMargin = estimatedRevenue > 0
                ? ((estimatedRevenue - revenue) / estimatedRevenue) * 100
                : 0;
            
            const overUnder = estimatedRevenue - revenue;
            
            return {
                totalHours,
                billableHours,
                nonBillableHours,
                revenue,
                estimatedRevenue,
                actualHourlyRate,
                effectiveHourlyRate,
                hoursProgress,
                budgetProgress,
                profitMargin,
                overUnder,
                entries
            };
        }

        function getProgressClass(progress) {
            if (progress >= 100) return 'danger';
            if (progress >= 80) return 'warning';
            return 'success';
        }

        // Dashboard rendering
        function renderDashboard() {
            const container = document.getElementById('projectList');
            
            if (data.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">No projects yet</div>
                        <p>Create your first project to start tracking time and budget.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            const activeProjects = data.projects.filter(p => p.status === 'active');
            
            activeProjects.forEach(project => {
                const stats = getProjectStats(project);
                const hoursClass = getProgressClass(stats.hoursProgress);
                const budgetClass = getProgressClass(stats.budgetProgress);
                
                const alert = stats.hoursProgress >= 80 ? `
                    <div class="alert ${stats.hoursProgress >= 100 ? 'alert-danger' : 'alert-warning'}">
                        ‚ö†Ô∏è Project ${stats.hoursProgress >= 100 ? 'over' : 'approaching'} budget limit (${stats.hoursProgress.toFixed(0)}% of hours used)
                    </div>
                ` : '';

                html += `
                    <div class="project-item" onclick="openProjectDetail('${project.id}')">
                        ${alert}
                        <div class="project-header">
                            <div>
                                <div class="project-name">${project.name}</div>
                                <div class="project-client">${project.client}</div>
                            </div>
                            <div>
                                <span class="badge badge-${project.budgetType === 'fixed' ? 'info' : 'success'}">
                                    ${project.budgetType === 'fixed' ? 'Fixed Price' : 'Hourly'}
                                </span>
                            </div>
                        </div>
                        <div class="project-meta">
                            ${project.deadline ? `<span>üìÖ Due: ${formatDate(project.deadline)}</span>` : ''}
                            <span>üí∞ ¬£${stats.revenue.toFixed(2)} / ¬£${stats.estimatedRevenue.toFixed(2)}</span>
                            <span>‚è±Ô∏è ${stats.totalHours.toFixed(1)}h / ${project.estimatedHours}h</span>
                        </div>
                        <div>
                            <div class="progress-label">Hours Progress</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar ${hoursClass}" style="width: ${Math.min(stats.hoursProgress, 100)}%">
                                    ${stats.hoursProgress.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="progress-label">Budget Progress</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar ${budgetClass}" style="width: ${Math.min(stats.budgetProgress, 100)}%">
                                    ${stats.budgetProgress.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Project detail view
        function openProjectDetail(projectId) {
            const project = data.projects.find(p => p.id === projectId);
            if (!project) return;

            const stats = getProjectStats(project);
            
            document.getElementById('projectDetailTitle').textContent = project.name;
            
            const activityBreakdown = {};
            stats.entries.forEach(entry => {
                if (!activityBreakdown[entry.activity]) {
                    activityBreakdown[entry.activity] = 0;
                }
                activityBreakdown[entry.activity] += entry.hours;
            });

            let activityHTML = '<div style="margin: 20px 0;"><strong>Activity Breakdown:</strong><br>';
            Object.entries(activityBreakdown).forEach(([activity, hours]) => {
                const percentage = stats.totalHours > 0 ? (hours / stats.totalHours) * 100 : 0;
                activityHTML += `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${activity.charAt(0).toUpperCase() + activity.slice(1)}</span>
                            <span>${hours.toFixed(1)}h (${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            activityHTML += '</div>';

            let entriesHTML = '<div style="margin-top: 30px;"><strong>Time Entries:</strong></div>';
            if (stats.entries.length === 0) {
                entriesHTML += '<div class="empty-state"><p>No time entries yet</p></div>';
            } else {
                stats.entries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                    entriesHTML += `
                        <div class="time-entry">
                            <div class="time-entry-header">
                                <span class="time-entry-date">${formatDate(entry.date)}</span>
                                <span class="time-entry-hours">${entry.hours}h</span>
                            </div>
                            <div class="time-entry-description">${entry.description}</div>
                            <div class="time-entry-meta">
                                <span class="badge badge-info">${entry.activity}</span>
                                <span class="badge badge-${entry.billable ? 'success' : 'warning'}">
                                    ${entry.billable ? 'Billable' : 'Non-billable'}
                                </span>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTimeEntry('${entry.id}', '${project.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            const content = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-value">${stats.totalHours.toFixed(1)}</div>
                        <div class="stat-change">${stats.billableHours.toFixed(1)}h billable</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue</div>
                        <div class="stat-value">¬£${stats.revenue.toFixed(2)}</div>
                        <div class="stat-change">of ¬£${stats.estimatedRevenue.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Effective Rate</div>
                        <div class="stat-value">¬£${stats.effectiveHourlyRate.toFixed(2)}</div>
                        <div class="stat-change">per hour (all hours)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Over/Under</div>
                        <div class="stat-value ${stats.overUnder >= 0 ? 'positive' : 'negative'}">${stats.overUnder >= 0 ? '+' : ''}¬£${stats.overUnder.toFixed(2)}</div>
                        <div class="stat-change ${stats.overUnder >= 0 ? 'positive' : 'negative'}">
                            ${stats.overUnder >= 0 ? 'Under budget ‚úì' : 'Over budget'}
                        </div>
                    </div>
                </div>

                ${activityHTML}

                <div style="margin-top: 30px;">
                    <strong>Invoice Summary (Billable Hours):</strong>
                    <div style="margin-top: 10px; padding: 15px; background: var(--bg); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Billable Hours:</span>
                            <span><strong>${stats.billableHours.toFixed(2)}h</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Rate:</span>
                            <span><strong>¬£${project.hourlyRate.toFixed(2)}/hr</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--border); font-size: 16px;">
                            <span><strong>Total:</strong></span>
                            <span><strong>¬£${stats.revenue.toFixed(2)}</strong></span>
                        </div>
                    </div>
                </div>

                ${entriesHTML}

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button class="btn" onclick="event.stopPropagation(); openTimeEntryModal('${project.id}')">+ Log Time</button>
                    <button class="btn btn-danger" onclick="event.stopPropagation(); deleteProject('${project.id}')">Delete Project</button>
                </div>
            `;

            document.getElementById('projectDetailContent').innerHTML = content;
            openModal('projectDetailModal');
        }

        // Analytics rendering
        function renderAnalytics() {
            const allStats = data.projects.map(p => ({project: p, stats: getProjectStats(p)}));
            const totalRevenue = allStats.reduce((sum, s) => sum + s.stats.revenue, 0);
            const totalHours = allStats.reduce((sum, s) => sum + s.stats.totalHours, 0);
            const totalBillable = allStats.reduce((sum, s) => sum + s.stats.billableHours, 0);
            const avgHourlyRate = totalBillable > 0 ? totalRevenue / totalBillable : 0;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value">¬£${totalRevenue.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-value">${totalHours.toFixed(1)}</div>
                    <div class="stat-change">${totalBillable.toFixed(1)}h billable</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Hourly Rate</div>
                    <div class="stat-value">¬£${avgHourlyRate.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Projects</div>
                    <div class="stat-value">${data.projects.filter(p => p.status === 'active').length}</div>
                </div>
            `;

            document.getElementById('analyticsStats').innerHTML = statsHTML;

            // Activity breakdown across all projects
            const activityTotals = {};
            data.timeEntries.forEach(entry => {
                if (!activityTotals[entry.activity]) {
                    activityTotals[entry.activity] = 0;
                }
                activityTotals[entry.activity] += entry.hours;
            });

            let activityHTML = '<div style="margin-top: 20px;"><strong>Time by Activity (All Projects):</strong>';
            Object.entries(activityTotals).sort((a, b) => b[1] - a[1]).forEach(([activity, hours]) => {
                const percentage = totalHours > 0 ? (hours / totalHours) * 100 : 0;
                activityHTML += `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${activity.charAt(0).toUpperCase() + activity.slice(1)}</span>
                            <span>${hours.toFixed(1)}h (${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            activityHTML += '</div>';

            document.getElementById('activityBreakdown').innerHTML = activityHTML;
        }

        // Clients rendering
        function renderClients() {
            const clientData = {};
            
            data.projects.forEach(project => {
                if (!clientData[project.client]) {
                    clientData[project.client] = {
                        projects: [],
                        totalRevenue: 0,
                        totalHours: 0
                    };
                }
                
                const stats = getProjectStats(project);
                clientData[project.client].projects.push({project, stats});
                clientData[project.client].totalRevenue += stats.revenue;
                clientData[project.client].totalHours += stats.totalHours;
            });

            let html = '';
            Object.entries(clientData).sort((a, b) => b[1].totalRevenue - a[1].totalRevenue).forEach(([client, data]) => {
                const avgRate = data.totalHours > 0 ? data.totalRevenue / data.totalHours : 0;
                
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${client}</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Revenue</div>
                                <div class="stat-value">¬£${data.totalRevenue.toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Hours</div>
                                <div class="stat-value">${data.totalHours.toFixed(1)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg Rate</div>
                                <div class="stat-value">¬£${avgRate.toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Projects</div>
                                <div class="stat-value">${data.projects.length}</div>
                            </div>
                        </div>
                        <table style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Hours</th>
                                    <th>Revenue</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.projects.map(p => `
                                    <tr onclick="openProjectDetail('${p.project.id}')" style="cursor: pointer;">
                                        <td>${p.project.name}</td>
                                        <td>${p.stats.totalHours.toFixed(1)}h</td>
                                        <td>¬£${p.stats.revenue.toFixed(2)}</td>
                                        <td>
                                            <span class="badge badge-${getProgressClass(p.stats.hoursProgress)}">
                                                ${p.stats.hoursProgress.toFixed(0)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            document.getElementById('clientsList').innerHTML = html || '<div class="empty-state"><p>No clients yet</p></div>';
        }

        // Templates rendering
        function renderTemplates() {
            const container = document.getElementById('templatesList');
            
            if (data.templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">No templates yet</div>
                        <p>Create templates for common project types to speed up project creation.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            data.templates.forEach(template => {
                const estimatedRevenue = template.estimatedHours * template.hourlyRate;
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${template.name}</div>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
                        </div>
                        <p style="color: var(--text-muted); margin-bottom: 15px;">${template.description || 'No description'}</p>
                        <div style="display: flex; gap: 20px; font-size: 14px;">
                            <span><strong>Hours:</strong> ${template.estimatedHours}</span>
                            <span><strong>Rate:</strong> ¬£${template.hourlyRate.toFixed(2)}/hr</span>
                            <span><strong>Est. Revenue:</strong> ¬£${estimatedRevenue.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Export functions
        function exportProjects() {
            const csv = ['Project,Client,Start Date,Deadline,Budget Type,Hourly Rate,Estimated Hours,Fixed Budget,Total Hours,Revenue,Status'];
            
            data.projects.forEach(project => {
                const stats = getProjectStats(project);
                csv.push([
                    project.name,
                    project.client,
                    project.startDate,
                    project.deadline,
                    project.budgetType,
                    project.hourlyRate,
                    project.estimatedHours,
                    project.fixedBudget,
                    stats.totalHours,
                    stats.revenue,
                    project.status
                ].map(v => `"${v}"`).join(','));
            });

            downloadCSV(csv.join('\n'), 'projects-export.csv');
        }

        function exportTimeEntries() {
            const csv = ['Date,Project,Client,Description,Hours,Activity,Billable,Hourly Rate,Value'];
            
            data.timeEntries.forEach(entry => {
                const project = data.projects.find(p => p.id === entry.projectId);
                if (!project) return;
                
                const value = entry.billable ? entry.hours * project.hourlyRate : 0;
                
                csv.push([
                    entry.date,
                    project.name,
                    project.client,
                    entry.description,
                    entry.hours,
                    entry.activity,
                    entry.billable ? 'Yes' : 'No',
                    project.hourlyRate,
                    value.toFixed(2)
                ].map(v => `"${v}"`).join(','));
            });

            downloadCSV(csv.join('\n'), 'time-entries-export.csv');
        }

        function exportInvoiceData() {
            const csv = ['Client,Project,Billable Hours,Hourly Rate,Total'];
            
            data.projects.forEach(project => {
                const stats = getProjectStats(project);
                csv.push([
                    project.client,
                    project.name,
                    stats.billableHours.toFixed(2),
                    project.hourlyRate.toFixed(2),
                    stats.revenue.toFixed(2)
                ].map(v => `"${v}"`).join(','));
            });

            downloadCSV(csv.join('\n'), 'invoice-data-export.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function backupData() {
            const backup = JSON.stringify(data, null, 2);
            const blob = new Blob([backup], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `project-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to clear ALL data? This cannot be undone!')) return;
            if (!confirm('Really? This will delete all projects, time entries, and templates permanently.')) return;
            
            localStorage.removeItem('projectTrackerData');
            data = { projects: [], timeEntries: [], templates: [] };
            renderDashboard();
            alert('All data cleared.');
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>